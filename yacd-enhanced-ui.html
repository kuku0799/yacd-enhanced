<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yacd Enhanced</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); 
            color: #fff; 
            min-height: 100vh;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: rgba(42, 42, 42, 0.95); 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.3); 
            backdrop-filter: blur(10px);
        }
        .header { 
            text-align: center; 
            margin-bottom: 40px; 
            border-bottom: 3px solid #007bff; 
            padding-bottom: 20px; 
        }
        .header h1 {
            font-size: 2.5em;
            margin: 0;
            background: linear-gradient(45deg, #007bff, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .feature { 
            margin: 25px 0; 
            padding: 25px; 
            border: 1px solid #444; 
            border-radius: 12px; 
            background: rgba(51, 51, 51, 0.8); 
            transition: all 0.3s ease;
        }
        .feature:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border-color: #007bff;
        }
        .btn { 
            display: inline-block; 
            padding: 12px 24px; 
            background: linear-gradient(45deg, #007bff, #0056b3); 
            color: white; 
            text-decoration: none; 
            border-radius: 8px; 
            margin: 8px; 
            border: none; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }
        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-danger { 
            background: linear-gradient(45deg, #dc3545, #c82333); 
            box-shadow: 0 4px 15px rgba(220,53,69,0.3);
        }
        .btn-danger:hover { 
            box-shadow: 0 6px 20px rgba(220,53,69,0.4);
        }
        .btn-success { 
            background: linear-gradient(45deg, #28a745, #218838); 
            box-shadow: 0 4px 15px rgba(40,167,69,0.3);
        }
        .btn-success:hover { 
            box-shadow: 0 6px 20px rgba(40,167,69,0.4);
        }
        .code { 
            background: #1e1e1e; 
            padding: 12px; 
            border-radius: 6px; 
            font-family: 'Courier New', monospace; 
            color: #00ff00; 
            border: 1px solid #333;
            display: block;
            margin: 10px 0;
        }
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #444;
            background: rgba(51, 51, 51, 0.5);
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }
        .tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
        }
        .tab:hover {
            background: rgba(0,123,255,0.2);
        }
        .tab.active {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: rgba(51, 51, 51, 0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #444;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #aaa;
            margin-top: 5px;
        }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        .input-group textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }
        .input-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }
        .alert-success {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
            color: #28a745;
        }
        .alert-error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #dc3545;
        }
        .alert-info {
            background: rgba(0, 123, 255, 0.2);
            border: 1px solid #007bff;
            color: #007bff;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .node-list {
            max-height: 300px;
            overflow-y: auto;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 10px;
        }
        .node-item {
            padding: 8px;
            margin: 4px 0;
            background: rgba(51, 51, 51, 0.8);
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #2a2a2a;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Yacd Enhanced</h1>
            <p>智能节点管理系统 - 专为OpenWrt优化</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">📊 概览</button>
            <button class="tab" onclick="showTab('nodes')">🔗 节点管理</button>
            <button class="tab" onclick="showTab('commands')">⚙️ 命令工具</button>
            <button class="tab" onclick="showTab('status')">📈 系统状态</button>
        </div>
        
        <div id="overview" class="tab-content active">
            <div class="feature">
                <h3>✨ 核心功能</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">4</div>
                        <div class="stat-label">协议支持</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="overview-node-count">-</div>
                        <div class="stat-label">节点数量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">24/7</div>
                        <div class="stat-label">自动监控</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">100%</div>
                        <div class="stat-label">兼容性</div>
                    </div>
                </div>
                <ul>
                    <li>🎯 可视化节点管理界面</li>
                    <li>🔗 多协议支持 (VMess/SS/Trojan/VLESS)</li>
                    <li>✅ 智能节点验证和过滤</li>
                    <li>📊 实时统计显示</li>
                    <li>📁 文件导入导出功能</li>
                    <li>🔄 自动监控和更新</li>
                </ul>
            </div>
            
            <div class="feature">
                <h3>📋 快速开始</h3>
                <p>访问地址：<span class="code">http://您的路由器IP:9090/ui/yacd/</span></p>
                <p>在监控面板中选择"节点管理"标签页开始使用</p>
            </div>
        </div>
        
        <div id="nodes" class="tab-content">
            <div class="feature">
                <h3>📝 节点管理</h3>
                <p>您可以通过以下方式管理节点：</p>
                <button class="btn" onclick="showNodeEditor()">📝 编辑节点文件</button>
                <button class="btn" onclick="loadNodes()">👁️ 查看当前节点</button>
                <button class="btn btn-success" onclick="updateNodes()">🔄 更新节点</button>
                <button class="btn btn-danger" onclick="clearNodes()">🗑️ 清空节点</button>
            </div>
            
            <div class="feature">
                <h3>📁 文件位置</h3>
                <p>节点文件：<span class="code">/root/OpenClashManage/wangluo/nodes.txt</span></p>
                <p>日志文件：<span class="code">/root/OpenClashManage/wangluo/log.txt</span></p>
                <p>脚本目录：<span class="code">/root/OpenClashManage/scripts/</span></p>
            </div>
            
            <div class="feature">
                <h3>🔗 支持的节点格式</h3>
                <ul>
                    <li><span class="code">vmess://base64编码配置</span></li>
                    <li><span class="code">ss://base64编码配置</span></li>
                    <li><span class="code">trojan://密码@服务器:端口?security=tls&type=tcp#备注</span></li>
                    <li><span class="code">vless://uuid@服务器:端口?encryption=none&security=tls&type=tcp#备注</span></li>
                </ul>
            </div>
            
            <div id="node-list-container" class="feature" style="display: none;">
                <h3>📋 当前节点列表</h3>
                <div id="node-list" class="node-list"></div>
            </div>
        </div>
        
        <div id="commands" class="tab-content">
            <div class="feature">
                <h3>⚙️ 常用命令</h3>
                <button class="btn" onclick="executeCommand('nano /root/OpenClashManage/wangluo/nodes.txt')">📝 编辑节点文件</button>
                <button class="btn" onclick="executeCommand('cat /root/OpenClashManage/wangluo/nodes.txt')">👁️ 查看节点</button>
                <button class="btn btn-success" onclick="executeCommand('python3 /root/OpenClashManage/scripts/zr.py')">🔄 更新节点</button>
                <button class="btn" onclick="executeCommand('/etc/init.d/yacd-enhanced-monitor status')">📊 监控状态</button>
                <button class="btn" onclick="executeCommand('/etc/init.d/openclash restart')">🔄 重启OpenClash</button>
                <button class="btn" onclick="executeCommand('tail -f /root/OpenClashManage/wangluo/log.txt')">📋 查看日志</button>
                <button class="btn btn-danger" onclick="executeCommand('echo "" > /root/OpenClashManage/wangluo/nodes.txt')">🗑️ 清空节点</button>
            </div>
            
            <div class="feature">
                <h3>🔧 服务管理</h3>
                <button class="btn" onclick="startMonitor()">▶️ 启动监控</button>
                <button class="btn" onclick="stopMonitor()">⏹️ 停止监控</button>
                <button class="btn" onclick="restartMonitor()">🔄 重启监控</button>
                <button class="btn" onclick="getMonitorStatus()">📊 监控状态</button>
            </div>
        </div>
        
        <div id="status" class="tab-content">
            <div class="feature">
                <h3>📈 系统状态</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="node-count">-</div>
                        <div class="stat-label">节点数量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="monitor-status">-</div>
                        <div class="stat-label">监控状态</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="openclash-status">-</div>
                        <div class="stat-label">OpenClash状态</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="nginx-status">-</div>
                        <div class="stat-label">Nginx状态</div>
                    </div>
                </div>
                <button class="btn" onclick="refreshStatus()">🔄 刷新状态</button>
            </div>
        </div>
    </div>
    
    <!-- 节点编辑器模态框 -->
    <div id="nodeEditorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeNodeEditor()">&times;</span>
            <h3>📝 编辑节点</h3>
            <div class="input-group">
                <label for="nodeContent">节点内容（每行一个节点）：</label>
                <textarea id="nodeContent" placeholder="请输入节点链接，每行一个..."></textarea>
            </div>
            <button class="btn btn-success" onclick="saveNodes()">💾 保存节点</button>
            <button class="btn" onclick="closeNodeEditor()">❌ 取消</button>
        </div>
    </div>
    
    <!-- 命令执行结果模态框 -->
    <div id="commandModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCommandModal()">&times;</span>
            <h3>📋 命令执行结果</h3>
            <div id="commandResult" class="code"></div>
            <button class="btn" onclick="closeCommandModal()">确定</button>
        </div>
    </div>
    
    <script>
        // API基础URL
        const API_BASE = 'http://localhost:5000/api';
        
        // 显示消息
        function showMessage(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            // 插入到页面顶部
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // 3秒后自动移除
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        // API请求函数
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API请求失败:', error);
                showMessage(`API请求失败: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }
        
        // 显示标签页
        function showTab(tabName) {
            // 隐藏所有标签内容
            var contents = document.getElementsByClassName('tab-content');
            for (var i = 0; i < contents.length; i++) {
                contents[i].classList.remove('active');
            }
            
            // 移除所有标签的active类
            var tabs = document.getElementsByClassName('tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // 显示选中的标签内容
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // 如果切换到状态标签，自动刷新状态
            if (tabName === 'status') {
                refreshStatus();
            }
        }
        
        // 加载节点列表
        async function loadNodes() {
            try {
                const result = await apiRequest('/nodes');
                if (result.success) {
                    const container = document.getElementById('node-list-container');
                    const list = document.getElementById('node-list');
                    
                    if (result.nodes && result.nodes.length > 0) {
                        list.innerHTML = result.nodes.map(node => 
                            `<div class="node-item">${node}</div>`
                        ).join('');
                        container.style.display = 'block';
                        showMessage(`成功加载 ${result.count} 个节点`, 'success');
                    } else {
                        list.innerHTML = '<div class="node-item">暂无节点</div>';
                        container.style.display = 'block';
                        showMessage('节点列表为空', 'info');
                    }
                } else {
                    showMessage(`加载节点失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('加载节点失败', 'error');
            }
        }
        
        // 显示节点编辑器
        async function showNodeEditor() {
            try {
                const result = await apiRequest('/nodes');
                if (result.success) {
                    document.getElementById('nodeContent').value = result.nodes.join('\n');
                    document.getElementById('nodeEditorModal').style.display = 'block';
                } else {
                    showMessage(`获取节点失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('获取节点失败', 'error');
            }
        }
        
        // 关闭节点编辑器
        function closeNodeEditor() {
            document.getElementById('nodeEditorModal').style.display = 'none';
        }
        
        // 保存节点
        async function saveNodes() {
            const content = document.getElementById('nodeContent').value;
            const nodes = content.split('\n').filter(line => line.trim());
            
            try {
                const result = await apiRequest('/nodes', {
                    method: 'POST',
                    body: JSON.stringify({ nodes: nodes })
                });
                
                if (result.success) {
                    showMessage(result.message || '节点保存成功', 'success');
                    closeNodeEditor();
                    loadNodes();
                } else {
                    showMessage(`保存节点失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('保存节点失败', 'error');
            }
        }
        
        // 更新节点
        async function updateNodes() {
            try {
                const result = await apiRequest('/nodes/update', {
                    method: 'POST'
                });
                
                if (result.success) {
                    showMessage('节点更新成功', 'success');
                } else {
                    showMessage(`更新节点失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('更新节点失败', 'error');
            }
        }
        
        // 清空节点
        async function clearNodes() {
            if (!confirm('确定要清空所有节点吗？')) {
                return;
            }
            
            try {
                const result = await apiRequest('/nodes', {
                    method: 'DELETE'
                });
                
                if (result.success) {
                    showMessage('节点已清空', 'success');
                    loadNodes();
                } else {
                    showMessage(`清空节点失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('清空节点失败', 'error');
            }
        }
        
        // 执行命令
        async function executeCommand(command) {
            try {
                const result = await apiRequest('/system/command', {
                    method: 'POST',
                    body: JSON.stringify({ command: command })
                });
                
                if (result.success) {
                    document.getElementById('commandResult').textContent = result.output || '命令执行成功';
                } else {
                    document.getElementById('commandResult').textContent = result.error || '命令执行失败';
                }
                
                document.getElementById('commandModal').style.display = 'block';
            } catch (error) {
                showMessage('执行命令失败', 'error');
            }
        }
        
        // 关闭命令模态框
        function closeCommandModal() {
            document.getElementById('commandModal').style.display = 'none';
        }
        
        // 启动监控
        async function startMonitor() {
            try {
                const result = await apiRequest('/monitor/start', {
                    method: 'POST'
                });
                
                if (result.success) {
                    showMessage('监控服务启动成功', 'success');
                } else {
                    showMessage(`启动监控失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('启动监控失败', 'error');
            }
        }
        
        // 停止监控
        async function stopMonitor() {
            try {
                const result = await apiRequest('/monitor/stop', {
                    method: 'POST'
                });
                
                if (result.success) {
                    showMessage('监控服务停止成功', 'success');
                } else {
                    showMessage(`停止监控失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('停止监控失败', 'error');
            }
        }
        
        // 重启监控
        async function restartMonitor() {
            try {
                const result = await apiRequest('/monitor/restart', {
                    method: 'POST'
                });
                
                if (result.success) {
                    showMessage('监控服务重启成功', 'success');
                } else {
                    showMessage(`重启监控失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('重启监控失败', 'error');
            }
        }
        
        // 获取监控状态
        async function getMonitorStatus() {
            try {
                const result = await apiRequest('/monitor/status');
                
                if (result.success) {
                    showMessage(`监控状态: ${result.output}`, 'info');
                } else {
                    showMessage(`获取监控状态失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('获取监控状态失败', 'error');
            }
        }
        
        // 刷新系统状态
        async function refreshStatus() {
            try {
                const result = await apiRequest('/system/status');
                
                if (result.success) {
                    const status = result.status;
                    document.getElementById('node-count').textContent = status.node_count || 0;
                    document.getElementById('monitor-status').textContent = status.monitor_status || '未知';
                    document.getElementById('openclash-status').textContent = status.openclash_status || '未知';
                    document.getElementById('nginx-status').textContent = status.nginx_status || '未知';
                    
                    // 更新概览页面的节点数量
                    document.getElementById('overview-node-count').textContent = status.node_count || 0;
                } else {
                    showMessage(`获取系统状态失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('获取系统状态失败', 'error');
            }
        }
        
        // 页面加载时初始化
        window.onload = function() {
            refreshStatus();
            loadNodes();
        };
        
        // 点击模态框外部关闭
        window.onclick = function(event) {
            const nodeModal = document.getElementById('nodeEditorModal');
            const commandModal = document.getElementById('commandModal');
            
            if (event.target === nodeModal) {
                closeNodeEditor();
            }
            if (event.target === commandModal) {
                closeCommandModal();
            }
        };
    </script>
</body>
</html> 